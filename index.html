<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ICD-10 查詢（JSON 版）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }
    header {
      padding: 16px 24px;
      background: #111827;
      color: #fff;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    main {
      padding: 16px 24px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .toolbar label {
      font-size: 0.9rem;
      color: #374151;
    }
    .toolbar input[type="text"] {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      min-width: 260px;
      font-size: 0.95rem;
    }
    .toolbar select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #fff;
    }
    .toolbar .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .status {
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #6b7280;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }
    thead {
      background: #111827;
      color: #f9fafb;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
      text-align: left;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .code-cell {
      white-space: nowrap;
      font-weight: 600;
      color: #111827;
    }
    .desc-cell {
      max-width: 480px;
    }
    .desc-cell small {
      display: block;
      color: #6b7280;
    }
    .no-data {
      padding: 24px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ICD-10 查詢（使用 icd-10.json）</h1>
    <p>支援依代碼 / 關鍵字模糊搜尋，資料從 JSON 載入，不再在前端解析 Excel。</p>
  </header>

  <main>
    <div class="toolbar">
      <label>
        搜尋：
        <input
          type="text"
          id="searchInput"
          placeholder="輸入代碼或說明關鍵字，例如：A41、敗血症、肺炎..."
        />
      </label>

      <label>
        資料表（Sheet）：
        <select id="sheetSelect"></select>
      </label>

      <label>
        筛選方式：
        <select id="modeSelect">
          <option value="all">全部欄位模糊搜尋</option>
          <option value="code">只比對代碼開頭（Code starts with）</option>
        </select>
      </label>

      <span class="small">※ 目前先顯示前 200 筆結果，避免一次載入過多太卡。</span>
    </div>

    <div class="status" id="statusText">載入中...</div>

    <div id="tableContainer"></div>
  </main>

  <script>
    let icdRaw = null;       // 原始整個 JSON { sheetName: [rows...] }
    let currentSheet = null; // 目前選擇的 sheet 名稱
    let allRows = [];        // 目前 sheet 的所有列

    // 1. 一開始載入 JSON
    async function loadICDJson() {
      try {
        const res = await fetch("icd-10.json");
        if (!res.ok) throw new Error("載入失敗：" + res.status);
        icdRaw = await res.json();

        const sheetNames = Object.keys(icdRaw);
        if (sheetNames.length === 0) {
          setStatus("icd-10.json 內沒有任何工作表資料。");
          return;
        }

        // 填滿 sheet 下拉選單
        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";
        sheetNames.forEach((name, idx) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sheetSelect.appendChild(opt);
        });

        // 預設選第一個 sheet（你如果想固定用某一張，例如 ICD10Tab，可以改這裡）
        currentSheet = sheetNames[0];
        sheetSelect.value = currentSheet;

        allRows = icdRaw[currentSheet] || [];
        setStatus(`已載入工作表「${currentSheet}」，共 ${allRows.length} 筆。`);
        renderTable(allRows.slice(0, 200));

        // 綁定事件
        sheetSelect.addEventListener("change", onSheetChange);
        document.getElementById("searchInput").addEventListener("input", debounce(onSearchInput, 200));
        document.getElementById("modeSelect").addEventListener("change", onSearchInput);
      } catch (err) {
        console.error(err);
        setStatus("載入 icd-10.json 時發生錯誤：" + err.message);
      }
    }

    function setStatus(text) {
      document.getElementById("statusText").textContent = text;
    }

    function onSheetChange(e) {
      currentSheet = e.target.value;
      allRows = icdRaw[currentSheet] || [];
      document.getElementById("searchInput").value = "";
      setStatus(`已切換到「${currentSheet}」，共 ${allRows.length} 筆。`);
      renderTable(allRows.slice(0, 200));
    }

    function onSearchInput() {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const mode = document.getElementById("modeSelect").value;

      if (!keyword) {
        setStatus(`顯示「${currentSheet}」前 200 筆，共 ${allRows.length} 筆。`);
        renderTable(allRows.slice(0, 200));
        return;
      }

      let filtered;
      if (mode === "code") {
        // 嘗試抓「Code」欄位，沒有就 fallback
        filtered = allRows.filter(row => {
          const keys = Object.keys(row);
          const codeKey = keys.find(k => k.toLowerCase().includes("code")) || keys[0];
          const val = row[codeKey];
          return val && String(val).toLowerCase().startsWith(keyword);
        });
      } else {
        // all：所有欄位做模糊搜尋
        filtered = allRows.filter(row => {
          return Object.values(row).some(v => {
            if (v === null || v === undefined) return false;
            return String(v).toLowerCase().includes(keyword);
          });
        });
      }

      const limited = filtered.slice(0, 200);
      setStatus(
        `「${currentSheet}」符合「${keyword}」的有 ${filtered.length} 筆，顯示前 ${limited.length} 筆。`
      );
      renderTable(limited);
    }

    // 簡單 debounce，避免每打一個字就觸發太多次
    function debounce(fn, delay) {
      let timer = null;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // 根據資料動態畫表格
    function renderTable(rows) {
      const container = document.getElementById("tableContainer");
      container.innerHTML = "";

      if (!rows || rows.length === 0) {
        const div = document.createElement("div");
        div.className = "no-data";
        div.textContent = "目前沒有可顯示的資料。";
        container.appendChild(div);
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      const keys = Object.keys(rows[0] || {});
      const trHead = document.createElement("tr");
      keys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach(row => {
        const tr = document.createElement("tr");
        keys.forEach((k, idx) => {
          const td = document.createElement("td");
          const val = row[k];
          if (idx === 0) {
            td.className = "code-cell";
          } else {
            td.className = "desc-cell";
          }
          td.textContent = val === null || val === undefined ? "" : String(val);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // 啟動
    loadICDJson();
  </script>
</body>
</html>
