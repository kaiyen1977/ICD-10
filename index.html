<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ICD-10 工具總入口</title>

  <!-- XLSX：給 index 讀 Excel 用 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 12px 20px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    header .sub {
      font-size: 0.85rem;
      opacity: 0.85;
    }

    #top-bar {
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #e5e7eb;
      border-bottom: 1px solid #d1d5db;
    }
    #excelInput {
      padding: 4px;
      font-size: 0.9rem;
    }
    #excelStatus {
      font-size: 0.85rem;
      color: #4b5563;
      white-space: pre-line;
    }
    #excelStatus.error {
      color: #b91c1c;
    }
    #excelStatus.success {
      color: #065f46;
    }

    #tool-bar {
      padding: 8px 20px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .tool-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      background: white;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .tool-btn.active {
      background: #2563eb;
      border-color: #1d4ed8;
      color: white;
    }
    .tool-btn:hover:not(.active) {
      background: #e5e7eb;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #frameWrapper {
      flex: 1;
      border-top: 1px solid #e5e7eb;
    }
    #toolFrame {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    #pageStatus {
      font-size: 0.8rem;
      padding: 4px 20px;
      color: #6b7280;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>ICD-10 查詢工具整合頁</h1>
    <div class="sub">一次匯入 Excel，切換 Drug / External / ICD-10-CM / Neoplasms / PCS</div>
  </div>
</header>

<div id="top-bar">
  <label>
    Excel 檔（icd-10.xlsx）：
    <input type="file" id="excelInput" accept=".xlsx,.xls" />
  </label>
  <div id="excelStatus">尚未載入 Excel，請選擇檔案。</div>
</div>

<div id="tool-bar">
  <!-- data-page 必須和 GitHub 上的檔名大小寫一模一樣 -->
  <button class="tool-btn active" data-page="ICD-10-CM.html">ICD-10-CM</button>
  <button class="tool-btn" data-page="drug.html">Drug</button>
  <button class="tool-btn" data-page="external.html">External Causes</button>
  <button class="tool-btn" data-page="NEOPLASMS.html">Neoplasms</button>
  <button class="tool-btn" data-page="PCS.html">PCS</button>
</div>

<main>
  <div id="frameWrapper">
    <!-- 一個 iframe 動態切換子頁 -->
    <iframe id="toolFrame" src="ICD-10-CM.html"></iframe>
  </div>
  <div id="pageStatus">
    目前頁面：ICD-10-CM（請先於上方匯入 Excel 才能查詢）
  </div>
</main>

<script>
  // ===== 全域共用的 Excel 資料（給子頁用）=====
  // 結構會是：
  // window.ICD_SHARED_DATA = {
  //   fileName: "...",
  //   sheets: {
  //     icdIdx: [...],
  //     icdDesc: [...],
  //     drugIdx: [...],
  //     externalIdx: [...],
  //     neoplasms: [...],
  //     pcsTable: [...],
  //     pcsIdx: [...]
  //   }
  // };
  window.ICD_SHARED_DATA = { fileName: "", sheets: {} };

  const excelInput   = document.getElementById("excelInput");
  const excelStatus  = document.getElementById("excelStatus");
  const pageStatus   = document.getElementById("pageStatus");
  const toolFrame    = document.getElementById("toolFrame");
  const toolButtons  = Array.from(document.querySelectorAll(".tool-btn"));

  // 切換工具頁（切換 iframe src）
  toolButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      toolButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const page = btn.getAttribute("data-page");
      toolFrame.src = page;
      pageStatus.textContent = `目前頁面：${btn.textContent}（若已匯入 Excel，會共用同一份資料）`;

      // 每次換頁，等 iframe onload 後再補發一個 "Excel 已載入" 訊號
      toolFrame.addEventListener("load", () => {
        if (window.ICD_SHARED_DATA && window.ICD_SHARED_DATA.sheets &&
            Object.keys(window.ICD_SHARED_DATA.sheets).length > 0) {
          notifyChildExcelLoaded();
        }
      }, { once: true });
    });
  });

  // 匯入 Excel：只在 index 做一次
  excelInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    excelStatus.className = "";
    excelStatus.textContent = "讀取中…";

    const reader = new FileReader();
    reader.onload = function (evt) {
      try {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
          excelStatus.className = "error";
          excelStatus.textContent = "Excel 檔沒有任何工作表。";
          return;
        }

        const sheets = {};

        workbook.SheetNames.forEach(name => {
          const lower = name.toLowerCase();
          const json = XLSX.utils.sheet_to_json(workbook.Sheets[name], { defval: "" });

          if (lower === "icd10_idx") {
            sheets.icdIdx = json;
          } else if (lower === "icd10_desc") {
            sheets.icdDesc = json;
          } else if (lower === "drug_idx") {
            sheets.drugIdx = json;
          } else if (lower === "external_idx" || lower === "external") {
            sheets.externalIdx = json;
          } else if (lower === "neoplasms") {
            sheets.neoplasms = json;
          } else if (lower === "pcs_table") {
            sheets.pcsTable = json;
          } else if (lower === "pcs_idx") {
            sheets.pcsIdx = json;
          }
        });

        window.ICD_SHARED_DATA = {
          fileName: file.name,
          sheets: sheets
        };

        const loadedSheets = Object.keys(sheets)
          .map(k => `${k}（${sheets[k].length} 筆）`)
          .join("，");

        excelStatus.className = "success";
        excelStatus.textContent =
          `已載入：${file.name}\n` +
          (loadedSheets ? `已解析工作表：${loadedSheets}` : "（未找到對應的工作表名稱）");

        // 通知目前 iframe 子頁：「Excel 已載入」
        notifyChildExcelLoaded();
      } catch (err) {
        console.error(err);
        excelStatus.className = "error";
        excelStatus.textContent = "讀取或解析 Excel 時發生錯誤：" + err.message;
      }
    };
    reader.onerror = function (err) {
      console.error(err);
      excelStatus.className = "error";
      excelStatus.textContent = "檔案讀取失敗。";
    };
    reader.readAsArrayBuffer(file);
  });

  // 用 postMessage 通知子頁重新從 parent 讀取 ICD_SHARED_DATA
  function notifyChildExcelLoaded() {
    if (!toolFrame || !toolFrame.contentWindow) return;
    toolFrame.contentWindow.postMessage({ type: "ICD_EXCEL_LOADED" }, "*");
  }

  // 頁面一開始：iframe 載入完成後，如果之前已載入過 Excel，就同步一次
  toolFrame.addEventListener("load", () => {
    if (window.ICD_SHARED_DATA && window.ICD_SHARED_DATA.sheets &&
        Object.keys(window.ICD_SHARED_DATA.sheets).length > 0) {
      notifyChildExcelLoaded();
    }
  });
</script>
</body>
</html>
